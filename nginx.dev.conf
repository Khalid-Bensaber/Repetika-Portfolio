events {}

http {
    resolver 127.0.0.11 ipv6=off valid=10s;
    resolver_timeout 5s;

    upstream $svc_cours      { server cours-service:8000; }
    upstream $svc_decks      { server decks-service:8000; }
    upstream $svc_planning   { server planning-service:8000; }
    upstream $svc_quiz       { server quiz-service:8000; }
    upstream $svc_session    { server session-service:8000; }
    upstream $svc_auth       { server authentification-service:8000; }
    upstream $svc_main       { server main-service:8000; }

    # CORS allowlist
    map $http_origin $allow_origin {
        default "";
        "~^https?://localhost(:\d+)?$"      $http_origin;
        "~^https?://127\.0\.0\.1(:\d+)?$"   $http_origin;
    }

    map $http_upgrade $connection_upgrade {
        default upgrade;
    ''      close;
  }
  server {
    listen 80;


    # CORS on every response
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Vary Origin always;
    add_header Access-Control-Allow-Credentials true always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

    if ($request_method = OPTIONS) { return 204; }

    # Proxy defaults
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade            $http_upgrade;
    proxy_set_header Connection         $connection_upgrade;

    # Route each API prefix to its service
    location /api/cours/ { proxy_pass http://svc_cours; }
    location /api/decks/ { proxy_pass http://svc_decks; }
    location /api/planning/ { proxy_pass http://svc_planning; }
    location /api/quiz/ { proxy_pass http://svc_quiz; }
    location /api/session/ { proxy_pass http://svc_session; }
    location /api/auth/ { proxy_pass http://svc_auth; }
    location /api/main/ { proxy_pass http://svc_main; }
    location /api/          { proxy_pass http://svc_main/api/; }

    # Uploads
    client_max_body_size 50m;
  }
}
