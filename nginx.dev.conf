events {}

http {
    resolver 127.0.0.11 ipv6=off valid=10s;
    resolver_timeout 5s;

    # CORS allowlist
    map $http_origin $allow_origin {
        default "";
        "~^https?://localhost(:\d+)?$"      $http_origin;
        "~^https?://127\.0\.0\.1(:\d+)?$"   $http_origin;
    }

    map $http_upgrade $connection_upgrade {
        default upgrade;
    ''      close;
  }
  server {
    listen 80;

    set $svc_cours      cours-service:8000;
    set $svc_decks      decks-service:8000;
    set $svc_planning   planning-service:8000;
    set $svc_quiz       quiz-service:8000;
    set $svc_session    session-service:8000;
    set $svc_auth       authentification-service:8000;
    set $svc_main       main-service:8000;
    # CORS on every response
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Vary Origin always;
    add_header Access-Control-Allow-Credentials true always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;

    if ($request_method = OPTIONS) { return 204; }

    # Proxy defaults
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade            $http_upgrade;
    proxy_set_header Connection         $connection_upgrade;

    # Route each API prefix to its service
    location /api/cours/ { proxy_pass http://$svc_cours; }
    location /api/decks/ { proxy_pass http://$svc_decks; }
    location /api/planning/ { proxy_pass http://$svc_planning; }
    location /api/quiz/ { proxy_pass http://$svc_quiz; }
    location /api/session/ { proxy_pass http://$svc_session; }
    location /api/auth/ { proxy_pass http://$svc_auth; }
    location /api/main/ { proxy_pass http://$svc_main; }
    location /api/          { proxy_pass http://$svc_main/api/; }

    # Uploads
    client_max_body_size 50m;
  }
}
